name: Build yt-dlp (x86 / i386)

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build-amd64:
    name: Build (amd64) - PyInstaller
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libssl-dev

      - name: Install Python deps & PyInstaller
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install pyinstaller
          if [ -f requirements.txt ]; then python -m pip install -r requirements.txt || true; fi

      - name: Build package (install editable)
        run: |
          python -m pip install .

      - name: Create onefile executable with PyInstaller
        run: |
          # entry point: yt_dlp.__main__ (module script)
          python -m PyInstaller --onefile --name yt-dlp yt_dlp/__main__.py
          mkdir -p dist
          cp dist/yt-dlp ./dist/yt-dlp-amd64
          strip ./dist/yt-dlp-amd64 || true

      - name: Smoke test executable
        run: |
          ./dist/yt-dlp-amd64 --version

      - name: Upload amd64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: yt-dlp-amd64
          path: dist/yt-dlp-amd64

  build-i386:
    name: Build (i386) - PyInstaller in i386 container
    runs-on: ubuntu-latest
    needs: []
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup QEMU (enable running i386 containers)
        uses: docker/setup-qemu-action@v2

      - name: Build inside i386 Python container
        # Using docker run with --platform linux/386; requires qemu from previous step
        run: |
          mkdir -p dist
          docker run --rm --platform linux/386 -v "${{ github.workspace }}":/src -w /src python:3.11-slim-bullseye bash -eux -c "
            apt-get update
            apt-get install -y --no-install-recommends build-essential pkg-config libssl-dev ca-certificates
            python -m pip install --upgrade pip setuptools wheel pyinstaller
            if [ -f requirements.txt ]; then python -m pip install -r requirements.txt || true; fi
            python -m pip install .
            python -m PyInstaller --onefile --name yt-dlp yt_dlp/__main__.py
            cp dist/yt-dlp /src/dist/yt-dlp-i386 || exit 1
            chown $(id -u):$(id -g) /src/dist/yt-dlp-i386
          "

      - name: Smoke test i386 executable (inside i386 container)
        run: |
          # run the built binary inside an i386 container to ensure it runs
          docker run --rm --platform linux/386 -v "${{ github.workspace }}/dist":/dist -w /dist python:3.11-slim-bullseye bash -c "./yt-dlp-i386 --version"

      - name: Upload i386 artifact
        uses: actions/upload-artifact@v4
        with:
          name: yt-dlp-i386
          path: dist/yt-dlp-i386
